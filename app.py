import streamlit as st
from datetime import datetime
import re
from openai import OpenAI

# =========================================================
# ê¸°ë³¸ ì„¤ì •
# =========================================================
st.set_page_config(
    page_title="ë¯¸ìƒµ ë¸”ë¡œê·¸ ì½˜í…ì¸  ìƒì„±ê¸°",
    page_icon="ğŸ“",
    layout="wide"
)

client = OpenAI(api_key=st.secrets.get("OPENAI_API_KEY"))
MODEL = st.secrets.get("OPENAI_MODEL", "gpt-4.1-mini")

# =========================================================
# í”Œë«í¼ë³„ ê¸€ì“°ê¸° í†¤ ê°€ì´ë“œ
# =========================================================
PLATFORM_GUIDE = {
    "ë„¤ì´ë²„": """
- ê³µê°ê³¼ ëŒ€í™” ë¦¬ë“¬ ìµœìš°ì„ 
- ë¬¸ë‹¨ ì§§ê²Œ, ì—°ê²° ë¬¸ì¥ ë§ê²Œ
- ìƒë‹´í•˜ë“¯ ë§ ê±¸ê¸°
- ì²´ë¥˜ì‹œê°„ì„ ëŠ˜ë¦¬ëŠ” íë¦„
""",
    "í‹°ìŠ¤í† ë¦¬": """
- ì •ë³´ íë¦„ì´ ë³´ì´ê²Œ ì •ë¦¬
- ì†Œì œëª©ì€ ìì—°ìŠ¤ëŸ½ê²Œ
- ì„¤ëª…ë³´ë‹¤ ê²½í—˜ ì¤‘ì‹¬
""",
    "ë¸”ë¡œê±°(êµ¬ê¸€)": """
- ê²½í—˜(E), ì „ë¬¸ì„±(E), ì‹ ë¢°(E) ê°•ì¡°
- ì´ìœ  â†’ ê²°ê³¼ â†’ ì •ë¦¬ íë¦„
- ë¬¸ì¥í˜• ì„¤ëª… ìœ ì§€
"""
}

# =========================================================
# ë¯¸ìƒµ ë¸”ë¡œê·¸ ê¸€ í”„ë¡¬í”„íŠ¸ (í˜•ì¤€ë‹˜ 2ë²ˆ ê¸€ ìŠ¤íƒ€ì¼ ê³ ì •)
# =========================================================
def build_misharp_prompt(
    platform,
    product_name,
    product_url,
    keywords,
    memo,
    size_info,
    review_text
):
    return f"""
[ì—­í• ]
ë„ˆëŠ” 20ë…„ì°¨ ì—¬ì„±ì˜ë¥˜ ì‡¼í•‘ëª° ë¯¸ìƒµ(MISHARP) ëŒ€í‘œë‹¤.
4050 ì—¬ì„± ê³ ê°ì„ ì‹¤ì œë¡œ ë§¤ì¼ ìƒë‹´í•´ì˜¨ í˜„ì¥í˜• ì‚¬ì¥ë‹˜ì´ë‹¤.
ì´ ê¸€ì€ ìƒí’ˆ ì„¤ëª…ì„œê°€ ì•„ë‹ˆë¼, ì˜·ê°€ê²Œì—ì„œ ì§ì ‘ ì´ì•¼ê¸°í•˜ë“¯ ì“°ëŠ” ë¸”ë¡œê·¸ ê¸€ì´ë‹¤.

[í”Œë«í¼ ê¸€ì“°ê¸° ê°€ì´ë“œ]
{PLATFORM_GUIDE[platform]}

[ì ˆëŒ€ ê·œì¹™]
1. ì²« ë¬¸ì¥ì€ ë°˜ë“œì‹œ ì•„ë˜ ë¬¸ì¥ ê·¸ëŒ€ë¡œ ì‹œì‘í•œë‹¤.
"ì•ˆë…•í•˜ì„¸ìš”^^ ì¼ìƒë„ ìŠ¤íƒ€ì¼ë„ ë¯¸ìƒµì²˜ëŸ¼ ì‹¬í”Œí•˜ê²Œ! 20ë…„ì°¨ ì—¬ì„±ì˜ë¥˜ ì‡¼í•‘ëª° ë¯¸ìƒµ ëŒ€í‘œì…ë‹ˆë‹¤."

2. ë‘ ë²ˆì§¸ ë¬¸ì¥ì€ ë°˜ë“œì‹œ ê³„ì ˆ/ë‚ ì”¨/ì‹œê¸° + ì˜·ì¥ ì• ê³ ë¯¼ ê³µê°ìœ¼ë¡œ ì“´ë‹¤.
3. ë¶„ëŸ‰ì€ 4,000~5,000ì.
4. êµ¬ë¶„ì„ (---, ===) ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€.
5. ë¦¬ìŠ¤íŠ¸(ë¶ˆë¦¿)ëŠ” ì•„ë˜ 2ê³³ì—ì„œë§Œ í—ˆìš©:
   - ì´ëŸ° ë¶„ë“¤ê»˜ ì¶”ì²œí•©ë‹ˆë‹¤
   - ì´ëŸ´ ë•Œ ìš”ê¸´í•´ìš”
6. ê·¸ ì™¸ ëª¨ë“  ë‚´ìš©ì€ ë°˜ë“œì‹œ ë¬¸ì¥í˜• ì„œìˆ ë¡œ ì‘ì„±í•œë‹¤.
7. ì•„ë˜ ë¬¸ì¥ì„ ë³¸ë¬¸ ì¤‘ ìµœì†Œ 2íšŒ ìì—°ìŠ¤ëŸ½ê²Œ í¬í•¨í•œë‹¤.
   - "ê³ ê°ë‹˜ë“¤ì´ ì œì¼ ë§ì´ í•˜ì‹œëŠ” ë§ì´ìš”."
   - "ì œê°€ 20ë…„ í•˜ë©´ì„œ í™•ì‹¤íˆ ëŠë‚€ ê±´ë°ìš”."
   - "ì—¬ê¸°ì„œ í¬ì¸íŠ¸ëŠ” ë”± í•˜ë‚˜ì˜ˆìš”."
8. ì½œë¡  í‘œê¸° ì‹œ ë°˜ë“œì‹œ í•œ ì¹¸ ë„ìš´ë‹¤. (ì˜ˆ: ì†Œì¬: ë©´ 100)
9. ë§ˆì§€ë§‰ ë¬¸ì¥ì€ ë°˜ë“œì‹œ ì•„ë˜ ë¬¸ì¥ìœ¼ë¡œ ëë‚¸ë‹¤.
"ì¼ìƒë„ ìŠ¤íƒ€ì¼ë„ ë¯¸ìƒµì²˜ëŸ¼, ì‹¬í”Œí•˜ê²Œ! MISHARP"

[ê¸€ì˜ ì„±ê²©]
- ì²´í¬ë¦¬ìŠ¤íŠ¸ âŒ
- ë³´ê³ ì„œ âŒ
- 4050 ì—¬ì„±ì—ê²Œ ìƒë‹´í•˜ë“¯ ë§ ê±°ëŠ” ë¸”ë¡œê·¸ ê¸€ â­•

[êµ¬ì„± ìˆœì„œ â€“ ìˆœì„œ ë°˜ë“œì‹œ ìœ ì§€]
1. ì œëª© (30~35ì, [ë¯¸ìƒµ] í¬í•¨, ìƒìœ„ í‚¤ì›Œë“œ 1ê°œ í¬í•¨)
2. ìµœìƒë‹¨ ìš”ì•½ (ë¬¸ì¥í˜• 3~5ì¤„)
3. ê³µê° ë„ì… (ìƒí™œ ì¥ë©´ ì¤‘ì‹¬ ì„œìˆ )
4. ì´ëŸ° ë¶„ë“¤ê»˜ ì¶”ì²œí•©ë‹ˆë‹¤ (ë¶ˆë¦¿ 5~7ê°œ)
5. ì´ëŸ´ ë•Œ ìš”ê¸´í•´ìš” (ë¶ˆë¦¿ 5~7ê°œ)
6. ì…ì—ˆì„ ë•Œ ë‹¬ë¼ì§€ëŠ” ëŠë‚Œ (ë””ìì¸/í• â€“ ë¬¸ì¥í˜• 2~3ë¬¸ë‹¨)
7. í•˜ë£¨ê°€ í¸í•´ì§€ëŠ” ì´ìœ  (ì†Œì¬/ì°©ìš©ê° â€“ ë¬¸ì¥í˜• 2~3ë¬¸ë‹¨)
8. ê²°êµ­ ì†ì´ ê°€ëŠ” ì˜·ì˜ ì¡°ê±´ (ê°€ì¹˜/ê°€ê²© â€“ ë¬¸ì¥í˜•)
9. í™œìš©ì„±ê³¼ ì½”ë”” ì´ì•¼ê¸° (TPO ì—°ê²° â€“ ë¬¸ì¥í˜•)
10. ì´ ì•„ì´í…œ, ê¼­ ë§Œë‚˜ë³´ì„¸ìš” (ê³µê° CTA â€“ ë¬¸ì¥í˜•)
11. ì•„ì´í…œ ì‚¬ì´ì¦ˆ ìŠ¤í™ í‘œ
12. ì‚¬ì´ì¦ˆ ì¶”ì²œ í‘œ
13. ìµœí•˜ë‹¨ ìš”ì•½ (ë¬¸ì¥í˜• 3ì¤„)
14. ì¸ìš© CTA (>) 2~3ì¤„
15. ìŠ¬ë¡œê±´
16. í•´ì‹œíƒœê·¸ 30ê°œ í•œ ì¤„

[ì…ë ¥ ì •ë³´]
ìƒí’ˆëª…: {product_name}
ìƒí’ˆ URL: {product_url}
í•µì‹¬ í‚¤ì›Œë“œ: {keywords}
ê¸°ì¡´ ë©”ëª¨/ì›ê³ :
{memo}

ì‚¬ì´ì¦ˆ ì •ë³´:
{size_info}

ê³ ê° í›„ê¸°:
{review_text}

[ì¶œë ¥ í˜•ì‹]
- 1ì¤„: ì œëª©
- ë¹ˆ ì¤„
- ë³¸ë¬¸
- ë§¨ ë§ˆì§€ë§‰ ì¤„: í•´ì‹œíƒœê·¸ 30ê°œ í•œ ì¤„
"""

# =========================================================
# ë¶ˆí•„ìš”í•œ ë¶ˆë¦¿ ìë™ ì œê±° (ë¬¸ì¥í˜• ë³´ì •)
# =========================================================
def normalize_text(text: str) -> str:
    lines = text.split("\n")
    result = []
    buffer = []

    def flush():
        if buffer:
            sentence = " ".join(buffer)
            sentence = re.sub(r"^[â€¢\-\d\. ]+", "", sentence)
            result.append(sentence)
            buffer.clear()

    for line in lines:
        if re.match(r"^\s*[-â€¢\d]+\.", line) or line.strip().startswith("-"):
            buffer.append(line.strip())
        else:
            flush()
            result.append(line)

    flush()
    return "\n".join(result)

# =========================================================
# UI
# =========================================================
st.title("ğŸ“ ë¯¸ìƒµ ë¸”ë¡œê·¸ ì½˜í…ì¸  ìƒì„±ê¸°")

platform = st.selectbox(
    "ë¸”ë¡œê·¸ í”Œë«í¼ ì„ íƒ",
    ["ë„¤ì´ë²„", "í‹°ìŠ¤í† ë¦¬", "ë¸”ë¡œê±°(êµ¬ê¸€)"]
)

product_name = st.text_input("ìƒí’ˆëª…")
product_url = st.text_input("ìƒí’ˆ URL")
keywords = st.text_input("í•µì‹¬ í‚¤ì›Œë“œ (ì½¤ë§ˆë¡œ êµ¬ë¶„)")
memo = st.text_area("ìƒí’ˆ ë©”ëª¨ / ê¸°ì¡´ ì›ê³ ", height=220)
size_info = st.text_area("ì‚¬ì´ì¦ˆ ì •ë³´", height=160)
review_text = st.text_area("ê³ ê° í›„ê¸° (ì—†ìœ¼ë©´ ë¹„ì›Œë‘ì„¸ìš”)", height=160)

if st.button("âœï¸ ê¸€ ìƒì„±í•˜ê¸°"):
    with st.spinner("ë¯¸ìƒµ ëŒ€í‘œê°€ ì§ì ‘ ê¸€ ì“°ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦"):
        prompt = build_misharp_prompt(
            platform,
            product_name,
            product_url,
            keywords,
            memo,
            size_info,
            review_text
        )

        response = client.responses.create(
            model=MODEL,
            input=prompt
        )

        raw_text = response.output_text
        final_text = normalize_text(raw_text)

        st.success("ë¸”ë¡œê·¸ ê¸€ ìƒì„± ì™„ë£Œ")
        st.text_area("ìƒì„±ëœ ë¸”ë¡œê·¸ ê¸€", final_text, height=650)

        filename = f"{datetime.now().strftime('%Y%m%d')}_{product_name[:10]}.txt"
        st.download_button(
            "TXT íŒŒì¼ ë‹¤ìš´ë¡œë“œ",
            final_text,
            file_name=filename
        )

# =========================================================
# Footer (ì¹´í”¼ë¼ì´íŠ¸ â€“ í•­ìƒ ìµœí•˜ë‹¨)
# =========================================================
st.markdown(
    """
    <div style="margin-top:60px; font-size:0.75rem; color:rgba(0,0,0,0.45); text-align:center;">
    â“’ ë¯¸ìƒµì»´í¼ë‹ˆ(MISHARP COMPANY). ë³¸ ì½˜í…ì¸ ì˜ ì €ì‘ê¶Œì€ ë¯¸ìƒµì»´í¼ë‹ˆì— ìˆìœ¼ë©°,
    ë¬´ë‹¨ ë³µì œÂ·ë°°í¬Â·ì „ì¬Â·2ì°¨ ê°€ê³µ ë° ìƒì—…ì  ì´ìš©ì„ ê¸ˆí•©ë‹ˆë‹¤.<br/>
    â“’ MISHARP COMPANY. All rights reserved.
    </div>
    """,
    unsafe_allow_html=True
)
